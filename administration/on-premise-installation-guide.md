# Инструкция по локальной установке

### Требования:

* Linux VM :
  * OS: Ubuntu \(версия: не раньше 18\);
  * Эта VM должна быть доступна со стороны кластера Kubernetes \(docker-реестр neuro будет установлен на эту VM – он содержит все docker-образы, требуемые для работы платформы\);
  * Эта VM должная иметь возможность доступаться к кластеру Kubernetes \(т.к. эта возможность требуется скрипту _**setup\_k8s.sh**_\);
  * Должны быть установлены следующие утилиты: _**docker, helm2, kubectl, htpasswd, openssl**._
* Дисковое пространство:
  * Возможность использовать **OpenEBS Cstor** – диски должны быть подсоединены к узлам Kubernetes. Эти диски также должны быть непримонтированы,  неформатированы, и видны как блочные устройства в кластере Kubernetes для того, чтобы **OpenEBS Cstor** мог их использовать.
* Кластер Kubernetes:
  * docker-образ **busybox:1.32.0** должен быть извлечён на каждом узле.
* SSL-сертификат для **Traefik** \(опционально\).

### .tar-архив и его структура

Чтобы получить последнюю версию архива, содержащего все требуемые файлы для установки платформы, свяжитесь с командой по адресу [team@neu.ro](mailto:team@neu.ro)

Структура этого архива такова:

#### _**/chartmuseum**_

Папка со всеми необходимыми helm-чартами. Она должна быть примонтирована как том для helm-репозитория **chartmuseum**.

#### _**/registry**_

Папка со всеми необходимыми docker-образами. Она должна быть примонтирована как том для docker-репозитория **registry**.    

#### _**registry.tar**_

Docker-образ **registry:2** в формате **.tar**.

#### _**chartmuseum.tar**_

Docker-образ **chartmuseum/chartmuseum:latest** в формате **.tar**.

#### _**neuro\_config.sh**_

Конфигурационный файл со всей требуемой информацией для установочного скрипта. Он должен быть дополнительно отредактирован в зависимости от требуемых в конкретном случае значений.

#### _**install.sh**_

Bash-скрипт, который будет выполнен на выделенной машине с реестром. Он делает следующее:

* Создаёт самозаверенный SSL-сертификат;
* Запускает docker-реестр;
* Запускает helm-репозиторий **chartmuseum**;

#### _**setup\_k8s.sh**_

Bash-скрипт, который будет выполнен на выделенной машине с реестром. Он делает следующее:

* Подготавливает кластер Kubernetes для платформы:
  * Создаёт необходимые дополнительные пространства имён;
  * Создаёт секреты с самозаверенными SSL-сертификатами и идентификационными данными для доступа к VM с docker-реестром **neuro**;
  * Пропатчивает сервисные аккаунты Kubernetes;
* Устанавливает **PostgreSQL**, **redis** и решение для дискового пространства в Kubernetes;
* Устанавливает платформу.

### Установка

1. Подсоединитесь к VM;

2. Примонтируйте USB или другое устройство внешнего хранения;

3. Создайте папку, в которую будет распакован архив **neuro.tar**, и распакуйте его:

```text
INSTALL_DIR=”/var/neuro”
mkdir –p $INSTALL_DIR
tar -xvf neuro.tar --directory $INSTALL_DIR
```

4. Настройте значения в _**neuro.config.sh**._

* Обязательные для настройки значения: 
  * `DOCKER_REGISTRY_VM_LOCAL_IP` \(частный IP VM, на которой будет установлен реестр **neuro**\).

5. Запустите _**install.sh**:_

```text
cd $INSTALL_DIR
chmod +x neuro_config.sh
chmod +x install.sh
./install.sh
```

6. Подсоединитесь к кластеру Kubernetes;

7. Запустите скрипт, который подготовит кластер Kubernetes cluster для платформы:

```text
chmod +x setup_k8s.sh
./setup_k8s.sh
```

