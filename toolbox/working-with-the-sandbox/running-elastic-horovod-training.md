# Запуск эластичного обучения с Horovod

[Horovod](https://github.com/horovod/horovod) - фреймворк для распределённого глубокого обучения, помогающий сделать процесс обучения быстрым и лёгким.

Horovod отлично подходит для ситуаций, в которых нужно запускать обучение в заданиях, работающих на вытесняемых экземплярах, так как у него есть специльно предназначенный для этого эластичный режим. Этот режим позволяет Horovod динамически масштабировать количество рабочих узлов во время обучения.

## Запуск Horovod с TensorFlow

Мы создали скрипт для запуска Horovod с TensorFlow, основанный на официальном [руководстве TensorFlow](https://www.tensorflow.org/tutorials/quickstart/beginner) и расширили его с помощью [этого руководста по Horovod](https://horovod.readthedocs.io/en/stable/elastic.html).

Вот как можно использовать этот скрипт на платформе.

### Подготовка

Вы можете скопировать [репозиторий с этим скриптом](https://github.com/neuro-inc/mlops-horovod-example), запуская такую команду:

```text
$ git clone https://github.com/neuro-inc/mlops-horovod-example.git
```

Когда он будет скопирован, переключитесь в его корневую локальную папку:

```text
$ cd <local-repo-path>
```

Теперь сгенерируйте SSH-ключ, позволяющий заданиям соединяться по SSH:

```text
$ ssh-keygen -t rsa -b 4096 -f ssh-keys/id_rsa -q -N ""
```

Сохраните приватную часть этого ключа. Она будет использована главным узлом для координации вторичных узлов:

```text
$ neuro secret add horovod-id-rsa @ssh-keys/id_rsa
```

Сохраните публичную часть SSH-ключа, которая будет использована вторичными узлами для валидации главного узла:

```text
$ neuro secret add horovod-id-rsa-pub @ssh-keys/id_rsa.pub
```

### Запуск главного узла обучения

Чтобы запустить главный узел обучения, выполните следующую команду:

```text
$ neuro-flow run main
```

Это задание подождёт появления вторичных узлов дополнительные 600 секунд \(см. "--start-timeout 600" в секции `bash` задания `main` \).

### Запуск вторичных узлов

Запустите такую команду несколько раз для создания рабочих узлов:

```text
$ neuro-flow run secondary
```

В нашем примере будут нужны как минимум два вторичных узла \(см. "--num-proc 2" в описании `bash` задания `main`\). Все эти рабочие узлы будут присоединены к экземпляру Horovod. 

Вытакже можете изменять количество вторичных узлов прямо во время процесса обучения. Каждый из них будет подключен и синхронизирован с главным процессом обучения - это главная функциональность Horovod в эластичном режиме.



